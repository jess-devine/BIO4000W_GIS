---
title: "README"
author: "Jess Devine"
date: "2025-02-27"
output: rmarkdown::github_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
library(rinat)
library(rosm)
library(ggspatial)
library(leaflet) 
library(htmltools)
library(mapview) 
library(leafpop) 
library(wesanderson)
```

## BIO4000W GIS Deliverable

```{r parameters}
# Define species name (change this variable for different species)
species_name <- "Virgilia oroboides"  

# Define bounding box (change if needed)
bounds <- c(-35, 18, -33.5, 18.5)
```

```{r vegdata}
veg <- st_read("data/cape_peninsula/cape_peninsula/veg/Vegetation_Indigenous.shp")

ggplot() + 
  geom_sf(data = veg, aes(fill = National_)) +
  scale_fill_viridis_d() +
  theme_minimal()
```

```{r cropping, echo=FALSE}
ext <- c(-66642.18, -3809853.29, -44412.18, -3750723.29) 
names(ext) <- c("xmin", "ymin", "xmax", "ymax") 
veg <- st_crop(veg, ext)

ggplot() + geom_sf(data=veg, aes(fill = `National_`))
```

```{r inatdata}
# Retrieve iNaturalist data for the specified species
inat_data <- get_inat_obs(taxon_name = species_name,
                          bounds = bounds,
                          maxresults = 1000)

dim(inat_data)

# Filter observations for accuracy, geographic location, and research quality
inat_data <- inat_data %>% 
  filter(positional_accuracy < 46 & 
         latitude < 0 &
         !is.na(latitude) &
         captive_cultivated == "false" &
         quality_grade == "research")

dim(inat_data)

# Convert to spatial object
inat_data <- st_as_sf(inat_data, coords = c("longitude", "latitude"), crs = 4326)
```

```{r plotting}
ggplot() + 
  annotation_map_tile(type = "osm", progress = "none") + 
  geom_sf(data = inat_data)
```

```{r reprojecting}
vegr <- st_read("data/cape_peninsula/cape_peninsula/veg/Vegetation_Indigenous_Remnants.shp")

inat_data <- st_transform(inat_data, st_crs(vegr))

inat_data <- st_intersection(inat_data, vegr)

dim(inat_data)

ggplot() + 
  annotation_map_tile(type = "osm", progress = "none") + 
  geom_sf(data = inat_data)
```

```{r buffering}
nsaf <- inat_data %>% 
  filter(National_ != "Southern Afrotemperate Forest") %>%
  st_buffer(dist = 250)

length(unique(nsaf$id))

nsaf <- st_intersection(nsaf, vegr) %>% 
  filter(National_.1 == "Southern Afrotemperate Forest")

length(unique(nsaf$id))
```

```{r final}
inat_data <- st_transform(inat_data, 4326)

pal <- colorFactor(viridis::viridis(length(unique(inat_data$National_))), 
                   domain = inat_data$National_)

leaflet(inat_data) %>%
  addTiles() %>%  
  addCircleMarkers(
    radius = 4, 
    color = ~pal(National_),  
    popup = ~paste0("<b>National Vegetation:</b> ", National_, "<br>",
                    "<b>Observation Link:</b> <a href='", url, "' target='_blank'>iNat</a>"),
    group = "Observations"
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = inat_data$National_,
    title = "National Vegetation Type",
    opacity = 1
  )

```
``` {r table}

# Convert sf objects to regular data frames before summarizing
no_buffer_summary <- inat_data %>%
  st_drop_geometry() %>%
  group_by(National_) %>%
  summarise(count_no_buffer = n())

buffer_summary <- nsaf %>%
  st_drop_geometry() %>%
  group_by(National_) %>%
  summarise(count_buffer = n())

# Perform full join
combined_summary <- full_join(no_buffer_summary, buffer_summary, by = "National_")

# Print table
print(combined_summary)

```