---
title: "README"
author: "Jess Devine"
date: "2025-02-27"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
library(rinat)
library(rosm)
library(ggspatial)
library(leaflet)
library(htmltools)
library(mapview)
library(leafpop)
library(wesanderson)
```

## R Markdown

```{r step1}
veg <- st_read("data/cape_peninsula/veg/Vegetation_Indigenous.shp")
#st_write(veg, "data/cape_peninsula/veg/Vegetation_Indigenous_duplicate.shp", append = FALSE)
plot(veg)
```

## Including Plots


```{r cropping, echo=FALSE}
ext <- c(-66642.18, -3809853.29, -44412.18, -3750723.29) 
names(ext) <- c("xmin", "ymin", "xmax", "ymax") 
veg <- st_crop(veg, ext)
ggplot() + geom_sf(data=veg, aes(fill = `National_`))
```

``` {r inat}
# read in inat observations for Virgilia divaricata
vd <- get_inat_obs(taxon_name = "Virgilia divaricata",
                   bounds = c(-35, 18, -33.5, 18.5),
                   maxresults = 1000)
# take only observations with geographic precision, southern hemisphere, has coordinates, isn't captive and is of research quality 
vd <- vd %>% filter(positional_accuracy<46 & 
                latitude<0 &
                !is.na(latitude) &
                captive_cultivated == "false" &
                quality_grade == "research")
# make vd a spartial object
vd <- st_as_sf(vd, coords = c("longitude", "latitude"), crs = 4326)
```

``` {r plotting}
ggplot() + 
  annotation_map_tile(type = "osm", progress = "none") + 
  geom_sf(data=vd)
leaflet() %>%
  # Add default OpenStreetMap map tiles
  addTiles(group = "Default") %>%  
  # Add our points
  addCircleMarkers(data = vd,
                   group = "Virgilia divaricata",
                   radius = 3, 
                   color = "green") 
mapview(vg, 
        popup = 
          popupTable(vg,
            zcol = c("user_login", "captive_cultivated", "url")))

lvg <- vg %>%
  mutate(click_url = paste("<b><a href='", url, "'>Link to iNat observation</a></b>"))

mapview(vg, 
        popup = 
          popupTable(lvg,
            zcol = c("user_login", "captive_cultivated", "click_url")))
```

```{r reprojecting}
#Get the remnants layer
vegr <- st_read("data/cape_peninsula/veg/Vegetation_Indigenous_Remnants.shp")
vg <- st_transform(vg, st_crs(vegr)) 
#call the dimensions of vg
dim(vg)  
pc <- st_intersection(pc, vegr)
dim(pc)
ggplot() + 
  annotation_map_tile(type = "osm", progress = "none") + 
  geom_sf(data=pc)

pal <- wes_palette("Darjeeling1", 7, type = "continuous")

ggplot() + 
  annotation_map_tile(type = "osm", progress = "none") + 
  geom_sf(data=pc, aes(col = National_)) +
  scale_colour_manual(values = pal)
pc %>% group_by(National_) %>% summarise(n())
```

```{r buffering}
#Find the localities that are not in Peninsula Sandstone Fynbos and add a 250m buffer
npsf <- pc %>% 
  filter(National_ != "Peninsula Sandstone Fynbos") %>%
  st_buffer(dist = 250)

#NOTE that st_buffer() makes them polygons, because they now have area!
npsf$geometry[1] #The first geometry in npsf
#Get the number of unique iNaturalist record numbers
length(unique(npsf$id)) 
#Intersect new polygons with veg remnants and filter for those that overlap Peninsula Sandstone Fynbos only
npsf <- st_intersection(npsf, vegr) %>% filter(National_.1 == "Peninsula Sandstone Fynbos")
#Get the number of unique iNaturalist record numbers that overlap PSF
length(unique(npsf$id))
```